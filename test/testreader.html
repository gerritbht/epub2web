<html>

<head>
	
	<META HTTP-EQUIV="content-type" CONTENT="text/html; charset=utf-8">

<style>

	body {
		margin:0; padding:0;
		text-align:center;
		background-color:#fff;
				/* background-image:url(http://fithfath.com/images/wp-content/uploads/2009/08/time.jpg); */
				/* http://www.a-gc.com/images/2012/11/outer-space-HD-Wallpapers.jpg */
	}

	#myheader {
		overflow:hidden;
		margin:0 auto;
		height:40px;
		background-color:#999;
		padding: 0;
		margin: 0;
	}

	#myheader toph1 {
		font-size:large;
		display:inline-block;
		color:#fff;
		font-family: sans-serif;
		line-height: 1em;
		padding: 0;
		margin: 0;
		margin: 10px .4em;
	}

	#hamburger {
		display:inline-block;
		vertical-align:middle;
		height:1em;
		width:1em;
		background: transparent url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAPCAYAAADtc08vAAAEJGlDQ1BJQ0MgUHJvZmlsZQAAOBGFVd9v21QUPolvUqQWPyBYR4eKxa9VU1u5GxqtxgZJk6XtShal6dgqJOQ6N4mpGwfb6baqT3uBNwb8AUDZAw9IPCENBmJ72fbAtElThyqqSUh76MQPISbtBVXhu3ZiJ1PEXPX6yznfOec7517bRD1fabWaGVWIlquunc8klZOnFpSeTYrSs9RLA9Sr6U4tkcvNEi7BFffO6+EdigjL7ZHu/k72I796i9zRiSJPwG4VHX0Z+AxRzNRrtksUvwf7+Gm3BtzzHPDTNgQCqwKXfZwSeNHHJz1OIT8JjtAq6xWtCLwGPLzYZi+3YV8DGMiT4VVuG7oiZpGzrZJhcs/hL49xtzH/Dy6bdfTsXYNY+5yluWO4D4neK/ZUvok/17X0HPBLsF+vuUlhfwX4j/rSfAJ4H1H0qZJ9dN7nR19frRTeBt4Fe9FwpwtN+2p1MXscGLHR9SXrmMgjONd1ZxKzpBeA71b4tNhj6JGoyFNp4GHgwUp9qplfmnFW5oTdy7NamcwCI49kv6fN5IAHgD+0rbyoBc3SOjczohbyS1drbq6pQdqumllRC/0ymTtej8gpbbuVwpQfyw66dqEZyxZKxtHpJn+tZnpnEdrYBbueF9qQn93S7HQGGHnYP7w6L+YGHNtd1FJitqPAR+hERCNOFi1i1alKO6RQnjKUxL1GNjwlMsiEhcPLYTEiT9ISbN15OY/jx4SMshe9LaJRpTvHr3C/ybFYP1PZAfwfYrPsMBtnE6SwN9ib7AhLwTrBDgUKcm06FSrTfSj187xPdVQWOk5Q8vxAfSiIUc7Z7xr6zY/+hpqwSyv0I0/QMTRb7RMgBxNodTfSPqdraz/sDjzKBrv4zu2+a2t0/HHzjd2Lbcc2sG7GtsL42K+xLfxtUgI7YHqKlqHK8HbCCXgjHT1cAdMlDetv4FnQ2lLasaOl6vmB0CMmwT/IPszSueHQqv6i/qluqF+oF9TfO2qEGTumJH0qfSv9KH0nfS/9TIp0Wboi/SRdlb6RLgU5u++9nyXYe69fYRPdil1o1WufNSdTTsp75BfllPy8/LI8G7AUuV8ek6fkvfDsCfbNDP0dvRh0CrNqTbV7LfEEGDQPJQadBtfGVMWEq3QWWdufk6ZSNsjG2PQjp3ZcnOWWing6noonSInvi0/Ex+IzAreevPhe+CawpgP1/pMTMDo64G0sTCXIM+KdOnFWRfQKdJvQzV1+Bt8OokmrdtY2yhVX2a+qrykJfMq4Ml3VR4cVzTQVz+UoNne4vcKLoyS+gyKO6EHe+75Fdt0Mbe5bRIf/wjvrVmhbqBN97RD1vxrahvBOfOYzoosH9bq94uejSOQGkVM6sN/7HelL4t10t9F4gPdVzydEOx83Gv+uNxo7XyL/FtFl8z9ZAHF4bBsrEwAAAAlwSFlzAAALEwAACxMBAJqcGAAAADZJREFUKBVj/P//PwMlgIkSzSC9FBvAAjJl3bp1JPsjKCiIkSouoNgLjJTGwmgYMDCMhgEDAwBuvRgVnXOYuAAAAABJRU5ErkJggg==) center center no-repeat;
	}
	
	#guide {
		position: absolute;
		height: 0%;
		top: 0%;
		left: 0%;
		width: 0%;
		overflow: auto;
	}

	#toc {
		position:relative;
		height: 100%;
		top: 0%;
		left: 15%;
		width: 70%;
		text-align: left;
		overflow:auto;
	}

	#coverImage {
		height:100%;
		width:100%;
		text-align:center;
		position:absolute;
		background-color:#fff;
		z-index: 1;
	}

	#coverImage img {
		max-height:100%;
		margin:0 auto;
		left:50%;
	}

	#content {
		position:relative;
		height: 100%;
		top: 0%;
		left: 15%;
		width: 70%;
		overflow:hidden;
		color: #000000;
	}

	.windowbox {
		text-align: left;
		padding:0%;
		margin:0;
		top:5%;
		height:95%;
		width:100%;
		display:none;
	}

	.navMap {
		font-size:1.5em;
		font-family:'Helvetica', 'Verdana', sans-serif;
		height:100%;
		overflow:auto;
		text-align:left;
		background-color:#666;
	}

	.navMap a {
		color:#39f;
		text-decoration:none;
	}

	.navMap a:visited {
		color:#888;
	}

	.navMap a.selected, .navMap a:hover {
		background-color:#666;
		color:white;
	}

	.navMap ul {
		margin-top:1em;
	}

	.navMap ul, .navMap li {
		list-style-type: none;
		line-height: 1.5em;
	}

	.navMap ol {
		list-style-type: none;
		line-height: 2em;
	}

	.navMap li {
		margin:.5em;
	}

	#navLeft, #navRight {
		position:fixed;
		text-align:center;
		margin:0 auto;
		height:100%;
		min-width:46px;
		top:0;
		opacity:.5;
		border:1px solid transparent;
	}

	#navLeft {
		left:10px;
	}

	#navRight {
		right:10px;
	}

	#navRight {
		background:#999 url(data:image/png;base64,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) no-repeat 10px center;
	}


	#navLeft {
		background:#999 url(data:image/png;base64,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) no-repeat 10px center;
	}

	.hover {
		cursor:pointer;
		opacity:.9 !important;
	}

</style>
</head>


<body>
	<!-- 

	ELEMENT LEGEND

		#header - contains an toph1 that may be displayed as a top banner or title

		#toc - outer div to contain cover, metadata and actual table of contents navigation

		.navMap - will contain an unordered list of toc items

		#content - will contain the main iframe for book content

		.windowbox - applies a percentage height and width and will scale with browser resize

	-->
<!--
	<div id="myheader">
		<toph1>Toggle TOC</toph1>
		<div id="hamburger"></div>
	</div>
-->

	<div id="toc" class="windowbox">

		<div id="coverImage">

		</div>

		<div class="navMap">

		</div>

	</div>


	<div id="navLeft">
		
	</div>


	<div id="content" class="windowbox">

	</div>


	<div id="navRight">
		
	</div>

	<!--

		SCRIPTS

			These may alternately be loaded in the document head. They load base JS libraries first, then supporting ones. Finally the reading system loop and event handlers are added.


	-->

	<!--simplifying by including JQuery externally, easier to find stuff :)-->
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

<script>

var reader = {
	// whatever reader functionality goes here
}
</script>

<script>

// leave the following line as is
// since the template substitution relies on it
// it will be populated with a full data
// description of the currently loaded epub

reader.config = {};

// make a shortcut to the easy object
// for easier access to the data

var d = reader.config.epub.easy;
var opsRoot = reader.config.epub.paths.opsRoot;
var prevItem = null, nextItem = null;
var navChain = [];
var navChainLookup = {};
var spineIndex = 0;
var i = 0;
var prev = null;
for (prop in d.linearSpine) {
	var ref = d.linearSpine[prop];
	navChain.push(ref.item.$);
	navChainLookup[opsRoot + ref.item.$.href] = i;
	i++;
}

</script>

<script>

var viewIsToc = false
, viewIsContent = false;

function viewTransitionContentToToc() {

	$('#content').hide();
	$('#toc').show();
	enable_scroll();

	viewIsContent = false;
	viewIsToc = true;
}

function viewTransitionTocToContent() {

	$('#toc').hide();
	$('#content').show();
	disable_scroll();

	viewIsContent = true;
		viewIsToc = false;	
}

function fadeCover() {
	$('#coverImage').fadeOut();
}

function handleTocHtml(html) {

	// receives a wad of html representing
	// navigable link list and overrides the
	// click handler on each one, allowing
	// more control over the navigation
	
	// Somehow need to seperate the GUIDE from the TOC for epub 3 (epub:type="landmarks")
	// Changed to NO guide, the ToC is a) sufficient and b) for simple reader presentation GUIDE is extra clutter
	
	$('#toc .navMap').empty();
	$('#toc .navMap').html(html);

	var links = $('.navMap a');
	links.click(function (e) {
		try {
			links.removeClass('selected');
			$(this).addClass('selected');
			var href = this.getAttribute('href');
			//console.log('href =', href);
			crossLoadHref(href);
			viewTransitionTocToContent();
			//loadHref(href);
		} catch (e) {
			console.log(e.message);
		}
		e.stopPropagation();
		e.preventDefault();
	});
}

function setSpineIndex(href) {
	try {
		//console.log("in", navChain);
		spineIndex = navChainLookup[href];
		// Handling for pg epubs which are weirdly formatted and cannot understand subsections
		// Without this there is no forward/back from certain points in the document
		
		if (typeof(spineIndex) == 'undefined') {
			spineIndex = navChainLookup[href.substr(0, href.indexOf('#'))];
			console.log('losing the #', spineIndex);
		}
	} catch (e) {
		console.log('exception: ', e);
	}
	console.log('index is ', spineIndex);
}

// XHR
function crossLoadHref(href) {
	console.log('crossloading href = ', href);
	var hrefNavPath = reader.config.epub.paths.navPath;
	if (hrefNavPath === undefined) {
		hrefNavPath = reader.config.epub.paths.opsRoot;
	}
	//var opsString = reader.config.epub.paths.opsRoot;
	var height;

	/* That should make ToC jumping work hopefully */
	pageOffset = 0;

	if (href.substr(0, hrefNavPath.length) != hrefNavPath) {
		if (href.substr(0, reader.config.epub.paths.opsRoot.length) != reader.config.epub.paths.opsRoot) {
			if(href.indexOf('/') > 0) {
				var temphref = href.substr(href.lastIndexOf('/')+1, href.length);
				console.log("temporary generated href", temphref);
				href = hrefNavPath + temphref;				
			} else {
				href = hrefNavPath + href;
			}
		}
	}

	disable_scroll(); //prevent the user from normal scrolling to create a page-like look-and-feel
	$('#content').empty();
	contentHeight = $('#content').height(); //height of the content box
	console.log('content height = ', contentHeight);
	if (href.match(/\.(xml|xhtml)/)) {
		$body = $('#content');
		$.get(href, function(data) {
			$body.html($(data).children());
			console.log("length would be ", getHeight());
		}, 'xml');
	}	else {
		$.get(href, function(data) {
			// handle data that's already in string form 
			$('#content').html(data); //<- temp to see anything at all
			console.log("length would be", getHeight());
			var elements = $('#content').contents();
			// Some debug info, useful for now
			//console.log('content should have ' + elements.length + ' elements');
		});
	}

	setSpineIndex(href);
	fixATags();

	var prevIndex = spineIndex - 1;
	var nextIndex = spineIndex + 1;

	prevItem = (prevIndex >= 0) ? navChain[prevIndex] : null;
	nextItem = (nextIndex < navChain.length) ? navChain[nextIndex] : null;
}

/* This is supposed to enable in-document link navigation */

function fixATags() {
	console.log("fixing <a> tags");
	var disContent = document.getElementById("content");
	var allATags = disContent.getElementsByTagName('a');
	var numberOfATags = allATags.length;

	//test
	//if (numberOfATags == 0) {alert("Something's fishy, a tags length == 0");}


	for(var i = 0; i < allATags.length; i++) {
		console.log("current href", allATags[i].href);
		allATags[i].onclick = function() {
			alert("clicked a link");
			if (this.href.match(/[a-f\d]{32}/)) {
				console.log("found a cached match");
				var match = this.href.match(/([\w\.\-#]*?)$/)
				if (match) {
					console.log("loading internally");
					crossLoadHref(match[0]);
				}
			} else {
				console.log("loading internally");
				crossLoadHref(this.href);
			}
		}
	}
}


function getHeight() {
	var temp = $('#content').find('p:last-of-type:last');
	if (typeof(temp["0"]) === "undefined") {
		console.log("no valid length"); //for a page with not even a p element ...
		var length = -1;
	} else {
		var length = (temp.height() + temp["0"].offsetTop);
	}
	return(length);
}

var pageOffset = 0;
var seenEnd = 0;

function nextFrame() {

	/* Find how long the content actually is */
	var maxLength = getHeight();

	/* Prepare for scrolling down the visible screen minus a grace portion to see cut characters */
	pageOffset += $('#content').height() - 20;

	/* Some debug output */
	console.log("maxlength = ", maxLength);
	console.log("pageOffset = " +  pageOffset + " jumping to " + (pageOffset + $('#content').height()));

	/* Decide whether to scroll or to show next chapter */

	/* View is longer than content, go immediately to the next href */
	if ($('#content').height() > maxLength) {
		pageOffset = 0;
		seenEnd = 0;
		var href = nextItem.href;
		crossLoadHref(href);
		return;
	}

	/* Seen everything, move on now */
	if ((pageOffset + $('#content').height()) >= maxLength && nextItem && seenEnd) {
		pageOffset = 0;
		seenEnd = 0;
		var href = nextItem.href;
		crossLoadHref(href);
	}

	/* The very last page, show TOC */
	else if ((pageOffset + $('#content').height() >= maxLength && seenEnd && (!nextItem))) {
		pageOffset = 0;
		seenEnd = 0;
		viewTransitionContentToToc();
	}		

	/* This scroll will let us see the very bottom, so next time jump chapters for real pagelike behavior append
		whitespace */
	else if ((pageOffset + $('#content').height()) >= maxLength && (!viewIsToc)) {
		console.log("seenEnd = TRUE");
		seenEnd = 1;
		while ((pageOffset + $('#content').height()) >= (maxLength + 20)) {
			$('#content').append("<p><br></p>");
			maxLength = getHeight();
			console.log("testing : " + maxLength + " " + (pageOffset + $('#content').height()));
		}
		$('#content').scrollTop(pageOffset);
	}
	/* Not time for next chapter yet, so just scroll down */
	else { 
		$('#content').scrollTop(pageOffset);
	}
	
}

function prevFrame() {
	/* TBD scroll not to the top of prev Chapter, but to the BOTTOM! for that find the length first */
	// Here scroll upwards in discrete steps equal to view height (minus a grace margin in case of split characters)
	console.log("pageOffset = " +  pageOffset + " jumping to " + (pageOffset - $('#content').height()));
	if (pageOffset == 0 && prevItem) {
		var href = prevItem.href;
		crossLoadHref(href);
		var maxLength = getHeight(); //<- This fires too soon
		console.log("maxLength =", maxLength);
		pageOffset = 0;
	} else if (pageOffset == 0 && !prevItem) {
		viewTransitionContentToToc();
	} else {
		pageOffset -= ($('#content').height() - 20);
		if (pageOffset <= 0) pageOffset = 0;
		$('#content').scrollTop(pageOffset);
	}
}

function close() {
	$.ajax({
		url:'/close'
	});
}

$(document).ready(function () {

	$('#navLeft, #navRight').on('mouseover', function () {
		$(this).addClass('hover');
	}).on('mouseout', function () {
		$(this).removeClass('hover');
	}).on('click', function () {
		// Reminder: Left Right navigation should first go over the whole page, THEN do a chapter change IF there is one
		console.log('clicked on ', this.id);
		if(this.id=='navLeft') {
			seenEnd = 0;
			prevFrame();
		} else if(this.id=='navRight') {
			nextFrame();
		}
	});

	$('#hamburger').on('mouseover', function () {
		$(this).addClass('hover');
	}).on('mouseout', function () {
		$(this).removeClass('hover');
	}).on('click', function () {
		if(viewIsToc) {
		    viewTransitionTocToContent();
	    } else {
			viewTransitionContentToToc();
	    }
	});

	// Use whatever cover is available

	$('#coverImage').append('<img/>');
	if (d.epub2CoverUrl !== null) //Load Epub2 Cover
	{
		$('#coverImage img').attr('src', d.epub2CoverUrl);	
	} else if (d.epub3CoverId) {	//If there's no epub 2 Cover check for epub 3 Cover
		var coverId = d.epub3CoverId;
		$('#coverImage img').attr('src', opsRoot+d.itemHashById[coverId]["$"]["href"]); //Fixes CoverImage for mobydick
	} else {	// If there's neither we do not have a cover to show
		console.log('Neither epub2 nor epub3 coverimage');
	}
	
	setTimeout(fadeCover, 2000);

	// Prefer epub3 navigation over epub2 if there's both (which _can_ happen)
	// Logic moved into epub-cache: epub3navhtml simply gets written into htmlNav since it really shouldn't matter 
	// if there's an ncx and a navigation doc if  the epub3 takes precedence anyway

	handleTocHtml(reader.config.html.htmlNav);
	viewTransitionContentToToc();

});

var keys = [13, 32, 37, 38, 39, 40]; // enter, space, left, up, right, down

function preventDefault(e) {
	e = e || window.event;
	if (e.preventDefault) {
		e.preventDefault();
		}
	e.returnValue = false;
}

function keydown(e) {
	for (var i = keys.length; i--;) {
		if (e.keyCode === keys[i]) {
			if (e.which === 13) {
				if(viewIsToc) {
		    	viewTransitionTocToContent();
	     	} else {
					viewTransitionContentToToc();
	     	}
			} else if (e.which === 37) { //left, previous Chapter
				pageOffset = 0;
				prevFrame();
			} else if (e.which === 38) { //up
				seenEnd = 0;
				prevFrame();
			}	else if (e.which === 39) { //right, next chapter
				pageOffset = Math.pow(2,31) - 1;
				seenEnd = 1;
				nextFrame();
			}	else if (e.which === 32 || e.which === 40 ) { //down or space
				nextFrame();
			}
			preventDefault(e);
			return;
		}
	}
}

/* Allow scrolling in ToC but keep control of the enter key */
function keydownToc(e) {
	if (e.which === 13) {
		viewTransitionTocToContent();
	}
}

function wheel(e) {
	preventDefault(e);
}

function disable_scroll() {
	if (window.addEventListener) {
		window.addEventListener('DOMMouseScroll', wheel, false);
	}
	window.onmousewheel = document.onmousewheel = wheel;
	document.onkeydown = keydown;
}

function enable_scroll() {
	if  (window.removeEventListener) {
		window.removeEventListener('DOMMouseScroll', wheel, false);
	}
	window.onmousewheel = document.onmousewheel = document.onkeydown = null;
	document.onkeydown = keydownToc;
}

</script>

</body>